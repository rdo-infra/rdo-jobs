---
# NOTE: It is more a workaround until the playbook would not be migrated
# to ci-framework project dir.
# NOTE: It is very similar to playbook:
# https://github.com/openstack-k8s-operators/ci-framework/blob/main/deploy-edpm.yml
- name: Run nested Ansible
  hosts: controller
  vars:
    framework_dir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/ci-framework"
    cifmw_parameters_file: "{{ ansible_user_dir }}/vars.yaml"
    cifmw_installyamls_repos: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/install_yamls"
    cifwm_data_folder: "{{ ansible_user_dir }}/ci-framework-data/artifacts/parameters"
    rdo_jobs_dir: "{{ ansible_user_dir }}/src/review.rdoproject.org/rdo-jobs"
    rdo_dir: "{{ rdo_jobs_dir }}/playbooks/data_plane_adoption"
    bootstrap_common_vars: "{{ rdo_dir }}/common_bootstrap_params.yml"
  tasks:
    - name: Install community.general collection
      ansible.builtin.command: ansible-galaxy collection install community.general

    - name: Run setup_crc_use_install_yamls_extracted_crc playbook
      ansible.builtin.command:
        cmd: >
          ansible-playbook
          -i "{{ ansible_user_dir }}/ci-framework-data/artifacts/zuul_inventory.yml"
          -e "@{{ ansible_user_dir }}/ci-framework-data/artifacts/parameters/zuul-params.yml"
          {{ rdo_jobs_dir }}/playbooks/data_plane_adoption/setup_crc_use_install_yamls_extracted_crc_playbook.yaml
      args:
        chdir: "{{ framework_dir }}"
