- hosts: undercloud
  gather_facts: false
  tasks:
    - name: Pull the tripleo passwords from undercloud vm
      ansible.builtin.fetch:
        src: /home/zuul/overcloud-deploy/overcloud/overcloud-passwords.yaml
        dest: /home/zuul/overcloud-passwords.yaml
        flat: true

    - name: Pull the private key from undercloud
      ansible.builtin.fetch:
        src: /home/zuul/.ssh/id_rsa
        dest: /home/zuul/edpm_ssh_key
        flat: true

    - name: Slurp crc public key for ssh access to standalone
      delegate_to: localhost  # localhost is the controller node in this case
      ansible.builtin.slurp:
        path: /home/zuul/.ssh/id_rsa.pub
      register: crc_ssh_key

    - name: Place crc public key to undercloud authorized_keys
      ansible.builtin.lineinfile:
        path: "/home/zuul/.ssh/authorized_keys"
        insertafter: "EOF"
        value: "{{ crc_ssh_key['content'] | b64decode | trim }}"

- hosts: "{{ groups['tripleo_computes'][0]}}"
  gather_facts: false
  tasks:
    - name: Reboot the 1st compute node to apply kernel args
      when:
        - use_hugepages|bool
        - prelaunch_test_instance|bool
      block:
        - name: Reboot to apply kernel args
          become: true
          ansible.builtin.reboot:
            post_reboot_delay: 60
            reboot_timeout: 600

        - name: Wait for connection
          ansible.builtin.wait_for_connection:
            delay: 10
            timeout: 600

        - name: Wait for service 'tripleo_nova_compute' to be running
          service_facts:
          register: services_result
          until: services_result.ansible_facts.services['tripleo_nova_compute.service'].state == 'running'
          retries: 20
          delay: 10
