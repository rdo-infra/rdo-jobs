- hosts: all
  gather_facts: false
  tasks:
    - name: Debug groups info
      run_once: true
      ansible.builtin.debug:
        msg: "{{ groups | to_nice_yaml }}"

- hosts: "{{ groups['tripleo_computes'] | first }}"
  gather_facts: false
  tasks:
    - name: Reboot the 1st compute node to apply kernel args
      when:
        - use_hugepages|default(false)|bool
        - prelaunch_test_instance|default(true)|bool
      block:
        - name: Reboot to apply kernel args
          become: true
          ansible.builtin.reboot:
            reboot_timeout: 600

        - name: Wait for connection
          ansible.builtin.wait_for_connection:
            delay: 10
            timeout: 600

        - name: Wait for service 'tripleo_nova_compute' to be running
          service_facts:
          register: services_result
          until: services_result.ansible_facts.services['tripleo_nova_compute.service'].state == 'running'
          retries: 20
          delay: 10
