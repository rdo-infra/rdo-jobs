- hosts: controller
  gather_facts: false
  vars:
    dpa_dir: "{{ dpa_dir_override | default('/home/zuul/src/github.com/openstack-k8s-operators/data-plane-adoption') }}"
    rdo_dir: "/home/zuul/src/review.rdoproject.org/rdo-jobs/playbooks/data_plane_adoption"
    framework_dir: "/home/zuul/src/github.com/openstack-k8s-operators/ci-framework"
    cifmw_datadir: "/home/zuul/ci-framework-data"
    pre_adoption_tempest_dir: "/home/zuul/ci-framework-data/tests/pre-adoption-tempest/"
    source_mariadb_ips:
      - 172.17.0.100
    osp_17_repos:
      - openstack-17.1-for-rhel-9-x86_64-rpms
      - rhceph-7-tools-for-rhel-9-x86_64-rpms
      - fast-datapath-for-rhel-9-x86_64-rpms
      - rhel-9-for-x86_64-highavailability-eus-rpms
  tasks:
    - name: Ensure required standalone vars are set before any usage
      ansible.builtin.set_fact:
        standalone_scenario: true
        standalone_ip: "{{ standalone_ip | default('192.168.122.100') }}"
        standalone_gateway: "{{ standalone_gateway | default('192.168.122.1') }}"
        cloud_domain: "{{ cloud_domain | default('localdomain') }}"

    - name: Create inventory to run tasks inside vm
      ansible.builtin.template:
        src: "{{ playbook_dir }}/files/standalone_vm_inventory.yaml.j2"
        dest: "/home/zuul/{{ standalone_vm_inventory | default('standalone_vm_inventory') }}"

    - name: Install collections to use nmcli and libvirt ansible modules
      ansible.builtin.command: ansible-galaxy collection install community.general community.libvirt

    - name: Write repo commands and deploy standalone using ci-framework without a vm
      block:
        - name: Write out the repo setup commands to file for standalone to use
          ansible.builtin.lineinfile:
            create: true
            path: "/home/zuul/cdn_subscription_repos.sh"
            value: "subscription-manager repos --enable {{ osp_17_repos | join(' --enable ') }}"

        - name: Deploy the standalone with ci_framework_deploy_standalone_vm.yaml
          ansible.builtin.shell: >
            ansible-playbook {{ rdo_dir }}/ci_framework_deploy_standalone_vm.yaml -e "job_name={{ zuul.job }}"
            {% if dpa_standalone_ntp_server is defined %}
            -e ntp_override={{ dpa_standalone_ntp_server }}
            {% endif %}
            -e repo_setup_commands=/home/zuul/cdn_subscription_repos.sh
            -e "standalone_ip={{ standalone_ip }}" -e "standalone_gateway={{ standalone_gateway }}"
            -e "standalone_dns={{ standalone_dns | default(standalone_gateway) }}"
            -e "use_ceph={{ use_ceph | default('true') }}"
            -e "cloud_domain={{ cloud_domain | default('localdomain') }}"
            -e "enable_tls={{ enable_tls | default('false') }}"
            -e "enable_telemetry={{ enable_telemetry | default('false') }}"
            -e "enable_barbican={{ enable_barbican | default('false') }}"
            -e "enable_octavia={{ enable_octavia | default('true') }}"
            -e "swift_replicated={{ swift_replicated | default('false') }}"
          args:
            chdir: "{{ framework_dir }}"

    - name: Wait for standalone vm to be available
      ansible.builtin.wait_for:
        port: 22
        host: "{{ standalone_ip }}"
        delay: 10
        timeout: 300
      vars:
        ansible_user: root
        ansible_ssh_private_key_file: /home/zuul/src/github.com/openstack-k8s-operators/install_yamls/out/edpm/ansibleee-ssh-key-id_rsa

    - name: Accept standalone vm ssh host keys to avoid prompt connecting for the first time
      connection: local
      ansible.builtin.shell: |
        ssh-keygen -F {{ standalone_ip }} ||
          ssh-keyscan -H {{ standalone_ip }} >> ~/.ssh/known_hosts
      register: known_hosts_script
      changed_when: "'found' not in known_hosts_script.stdout"

    - name: Run test preparation in standalone vm
      ansible.builtin.shell:
        ansible-playbook {{ rdo_dir }}/standalone_prepare_tests.yaml -i /home/zuul/{{ standalone_vm_inventory | default("standalone_vm_inventory") }}

    - name: Read the standalone ssh key downloaded from standalone
      ansible.builtin.slurp:
        path: "{{ standalone_private_key | default('/home/zuul/src/github.com/openstack-k8s-operators/install_yamls/out/edpm/ansibleee-ssh-key-id_rsa') }}"
      register: standalone_key

    - name: Place standalone key into secrets.yaml
      ansible.builtin.lineinfile:
        path: "{{ rdo_dir }}/secrets.yaml"
        regexp: '^edpm_encoded_privatekey:'
        value: "edpm_encoded_privatekey: \"{{ standalone_key['content'] }}\""

    - name: Read the tripleo passwords downloaded from standalone
      ansible.builtin.slurp:
        path: /home/zuul/overcloud-passwords.yaml
      register: tripleo_passwords

    - name: Set tripleo passwords in secrets.yaml
      ansible.builtin.lineinfile:
        path: "{{ rdo_dir }}/secrets.yaml"
        regexp: "{{ item.key }}:"
        line: "{{ item.key }}: {{ tripleo_passwords['content'] | b64decode | regex_search(item.regex + ': (.+)', '\\1') | first }}"
      loop:
        - key: 'aodh_password'
          regex: 'AodhPassword'
        - key: 'barbican_password'
          regex: 'BarbicanPassword'
        - key: 'ceilometer_password'
          regex: 'CeilometerPassword'
        - key: 'glance_password'
          regex: 'GlancePassword'
        - key: 'placement_password'
          regex: 'PlacementPassword'
        - key: 'cinder_password'
          regex: 'CinderPassword'
        - key: 'neutron_password'
          regex: 'NeutronPassword'
        - key: 'heat_password'
          regex: 'HeatPassword'
        - key: 'heat_stack_domain_admin_password'
          regex: 'HeatStackDomainAdminPassword'
        - key: 'heat_auth_encryption_key'
          regex: 'HeatAuthEncryptionKey'
        - key: 'manila_password'
          regex: 'ManilaPassword'
        - key: 'ironic_password'
          regex: 'IronicPassword'
        - key: 'nova_password'
          regex: 'NovaPassword'
        - key: 'octavia_password'
          regex: 'OctaviaPassword'
        - key: 'swift_password'
          regex: 'SwiftPassword'
        - key: 'libvirt_password'
          regex: 'LibvirtTLSPassword'

    - name: Set standalone login var controller1_ssh in secrets.yaml
      ansible.builtin.lineinfile:
        path: "{{ rdo_dir }}/secrets.yaml"
        regexp: 'controller1_ssh:'
        value: "controller1_ssh: ssh -i {{ standalone_private_key | default('/home/zuul/src/github.com/openstack-k8s-operators/install_yamls/out/edpm/ansibleee-ssh-key-id_rsa') }} root@{{ standalone_ip }}"

    - name: Set ipa_ssh var in secrets.yaml
      ansible.builtin.lineinfile:
        path: "{{ rdo_dir }}/secrets.yaml"
        regexp: 'ipa_ssh:'
        value: "ipa_ssh: ssh -i {{ standalone_private_key | default('/home/zuul/src/github.com/openstack-k8s-operators/install_yamls/out/edpm/ansibleee-ssh-key-id_rsa') }} root@{{ standalone_ip }} podman exec -ti freeipa-server-container"

    - name: Install required packages
      become: true
      ansible.builtin.package:
        name:
          - python3
          - python3-pip

    - name: pip install openstackclient for keystone adoption on crc
      become: true
      ansible.builtin.pip:
        name: python-openstackclient
        executable: pip3

    - name: Fetch hash and set ci_testing_hash fact for periodic
      when: "'periodic' in zuul.job or (force_periodic|default(false)|bool)"
      block:
        - name: Fetch latest c9 or rhel9 antelope tag from dlrn
          when: dlrn_hash_tag is not defined
          ansible.builtin.uri:
            url: "https://{{ dpa_dlrn_server | default('trunk.rdoproject.org') }}/{{ dpa_dlrn_namespace | default('centos9-antelope') }}/{{ dpa_dlrn_tag | default('podified-ci-testing') }}/delorean.repo.md5"
            return_content: true
          register: latest_dlrn_tag
          until: latest_dlrn_tag.status == 200
          retries: 6
          delay: 5

    - name: Check if edpm-ansible.yml file was created
      ansible.builtin.stat:
        path: "/home/zuul/ci-framework-data/artifacts/edpm-ansible.yml"
      register: edpm_ansible_file

    - name: Read edpm_ansible file and extract ansibleee_runner img
      when: edpm_ansible_file.stat.exists
      block:
        - name: Read file
          ansible.builtin.slurp:
            path: "/home/zuul/ci-framework-data/artifacts/edpm-ansible.yml"
          register: edpm_ansible_output

        - name: Extract ansiblee_runner img
          vars:
            edpm_ansible_dict: "{{ edpm_ansible_output['content'] | b64decode | from_yaml }}"
          ansible.builtin.set_fact:
            ansibleee_runner_img: "{{ edpm_ansible_dict['cifmw_update_containers_ansibleee_image_url'] }}"

    - name: Workaround systemd-container
      # Note: This WA applies to version <= 17.1.3
      become: true
      delegate_to: standalone
      ansible.builtin.dnf:
        name:
          - systemd-container
        state: present

    - name: Update sos-reports package to use it with must-gather
      delegate_to: standalone
      become: true
      ansible.builtin.dnf:
        name: sos
        state: latest

    - name: Call test role before adoption tests
      become: true
      delegate_to: standalone
      tags:
        - tempest
      when:
        - dpa_run_pre_adoption_tempest | default(false) | bool
      import_tasks: run_tempest.yaml
      vars:
        os_cloud_name: standalone

    - name: Disable OSP17.1 repos before running OSP 18 setup and adoption
      delegate_to: standalone
      become: true
      ansible.builtin.shell: "subscription-manager repos --disable {{ osp_17_repos | join(' --disable ') }}"

    - name: Set facts as required by the vars.yaml template file
      ansible.builtin.set_fact:
        standalone_scenario: true
        standalone_ip: "{{ standalone_ip | default('192.168.122.100') }}"

    - name: Create vars from template file
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/deployment_vars.j2"
        dest: "{{ rdo_dir }}/vars.yaml"

    - name: DEBUG - Display contents of generated vars.yaml
      block:
        - name: Read the vars.yaml file
          ansible.builtin.command: "cat {{ rdo_dir }}/vars.yaml"
          register: vars_yaml_content
          changed_when: false

        - name: Print the file contents
          ansible.builtin.debug:
            var: vars_yaml_content.stdout_lines
      ignore_errors: true  # Use ignore_errors so it doesn't stop if the file is missing


    - name: "Run data-plane-adoption tests from {{ dpa_dir }}"
      community.general.make:
        chdir: "{{ dpa_dir }}"
        target: "{{ dpa_test_suite | default('test-with-ceph') }}"
        params:
          TEST_CONFIG: "{{ dpa_test_ansible_cfg | default(rdo_dir  ~ '/ansible.cfg') }}"
          TEST_SECRETS: "{{ rdo_dir }}/secrets.yaml"
          TEST_VARS: "{{ rdo_dir }}/vars.yaml"
          TEST_INVENTORY: "tests/inventory.sample-crc-vagrant.yaml"
      register: make_res
      failed_when: '"failed=0" not in make_res.stdout_lines[-1]'

    - name: Unregister tripleo osp17.1 nodes with subscription-manager
      delegate_to: standalone
      become: true
      failed_when: false
      ansible.builtin.shell: subscription-manager unregister

    - name: Call test role after adoption tests
      when:
        - dpa_run_post_adoption_tempest | default(true) | bool
        - cifmw_run_test_role is defined
      import_tasks: run_test_operator_tests.yaml

    - name: Mark job as successful
      when: not force_job_failure | default(false)
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/cifmw-success"
        state: touch
