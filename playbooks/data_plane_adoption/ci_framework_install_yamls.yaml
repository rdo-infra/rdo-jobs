- hosts: all
  vars:
    framework_dir: "/home/zuul/src/github.com/openstack-k8s-operators/ci-framework"
  tasks:
    - name: Run make openstack using install_yamls_makes
      vars:
        cifmw_install_yamls_vars:
          NAMESPACE: "openstack"
          CEILOMETER_CENTRAL_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ceilometer-central:podified-ci-testing"
          CEILOMETER_CENTRAL_INIT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ceilometer-central:podified-ci-testing"
          CEILOMETER_COMPUTE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ceilometer-compute:podified-ci-testing"
          CEILOMETER_COMPUTE_INIT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ceilometer-compute:podified-ci-testing"
          CEILOMETER_NOTIFICATION_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ceilometer-notification:podified-ci-testing"
          CEILOMETER_SGCORE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/infrawatch/sg-core:latest"
          CINDER_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-cinder-api:podified-ci-testing"
          CINDER_BACKUP_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-cinder-backup:podified-ci-testing"
          CINDER_SCHEDULER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-cinder-scheduler:podified-ci-testing"
          CINDER_VOLUME_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-cinder-volume:podified-ci-testing"
          GLANCE_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-glance-api:podified-ci-testing"
          HEAT_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-heat-api:podified-ci-testing"
          HEAT_CFNAPI_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-heat-api-cfn:podified-ci-testing"
          HEAT_ENGINE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-heat-engine:podified-ci-testing"
          HORIZON_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-horizon:podified-ci-testing"
          INFRA_CLIENT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-openstackclient:podified-ci-testing"
          INFRA_DNSMASQ_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-neutron-server:podified-ci-testing"
          INFRA_MEMCACHED_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-memcached:podified-ci-testing"
          INFRA_REDIS_IMAGE_URL_DEFAULT: "registry.redhat.io/rhel9/redis-6:latest"
          IRONIC_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ironic-api:podified-ci-testing"
          IRONIC_CONDUCTOR_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ironic-conductor:podified-ci-testing"
          IRONIC_INSPECTOR_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ironic-inspector:podified-ci-testing"
          IRONIC_NEUTRON_AGENT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ironic-neutron-agent:podified-ci-testing"
          IRONIC_PXE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ironic-pxe:podified-ci-testing"
          KEYSTONE_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-keystone:podified-ci-testing"
          MANILA_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-manila-api:podified-ci-testing"
          MANILA_SCHEDULER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-manila-scheduler:podified-ci-testing"
          MANILA_SHARE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-manila-share:podified-ci-testing"
          MARIADB_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-mariadb:podified-ci-testing"
          NEUTRON_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-neutron-server:podified-ci-testing"
          NOVA_ANSIBLE_EE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/openstack-k8s-operators/openstack-ansibleee-runner:latest"
          NOVA_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-api:podified-ci-testing"
          NOVA_COMPUTE_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-compute:podified-ci-testing"
          NOVA_CONDUCTOR_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-conductor:podified-ci-testing"
          NOVA_LIBVIRT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-libvirt:podified-ci-testing"
          NOVA_METADATA_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-api:podified-ci-testing"
          NOVA_NOVNC_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-novncproxy:podified-ci-testing"
          NOVA_SCHEDULER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-nova-scheduler:podified-ci-testing"
          OCTAVIA_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-octavia-api:podified-ci-testing"
          OPENSTACKCLIENT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-openstackclient:podified-ci-testing"
          OVN_CONTROLLER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ovn-controller:podified-ci-testing"
          OVN_CONTROLLER_OVS_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ovn-base:podified-ci-testing"
          OVN_NB_DBCLUSTER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ovn-nb-db-server:podified-ci-testing"
          OVN_NORTHD_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ovn-northd:podified-ci-testing"
          OVN_SB_DBCLUSTER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-ovn-sb-db-server:podified-ci-testing"
          PLACEMENT_API_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-placement-api:podified-ci-testing"
          SWIFT_ACCOUNT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-swift-account:podified-ci-testing"
          SWIFT_CONTAINER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-swift-container:podified-ci-testing"
          SWIFT_MEMCACHED_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-memcached:podified-ci-testing"
          SWIFT_OBJECT_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-swift-object:podified-ci-testing"
          SWIFT_PROXY_IMAGE_URL_DEFAULT: "quay.rdoproject.org/podified-antelope-centos9/openstack-swift-proxy-server:podified-ci-testing"
          TELEMETRY_NODE_EXPORTER_IMAGE_URL_DEFAULT: "quay.rdoproject.org/prometheus/node-exporter:v1.5.0"
      ansible.builtin.include_role:
        name: install_yamls_makes
        tasks_from: 'make_openstack'

    - name: Make sure all Openstack operators are deployed
      ansible.builtin.shell: |
        set -o pipefail && \
        oc get csv -l operators.coreos.com/openstack-operator.openstack-operators -n "openstack-operators" --no-headers=true | grep -i "succeeded"
      register: operator_status
      until: operator_status.rc == 0
      changed_when: false
      retries: 30
      delay: 30
