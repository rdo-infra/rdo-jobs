- hosts: all
  vars:
    framework_dir: "/home/zuul/src/github.com/openstack-k8s-operators/ci-framework"
  tasks:
    - name: Prepare for network isolation in crc env
      ansible.builtin.include_role:
        name: install_yamls_makes
        tasks_from: 'make_crc_attach_default_interface'

    - name: Run make openstack using install_yamls_makes and pass content provider openstack-operator image
      when:
        - cifmw_operator_build_output is defined
        - cifmw_operator_build_output['operators'] is defined
        - cifmw_operator_build_output['operators']['openstack-operator'] is defined
      ansible.builtin.include_role:
        name: install_yamls_makes
        tasks_from: 'make_openstack'
      vars:
        make_openstack_env:
          OPENSTACK_IMG: "{{ cifmw_operator_build_output['operators']['openstack-operator']['image_catalog'] }}"
          OPENSTACK_REPO: "{{ cifmw_operator_build_output['operators']['openstack-operator']['git_src_dir'] }}"

    - name: Run make openstack using install_yamls_makes without content provider
      when:
        - cifmw_operator_build_output is not defined
      ansible.builtin.include_role:
        name: install_yamls_makes
        tasks_from: 'make_openstack'

    - name: Make sure all Openstack operators are deployed
      ansible.builtin.shell: |
        set -o pipefail && \
        oc get csv -l operators.coreos.com/openstack-operator.openstack-operators -n "openstack-operators" --no-headers=true | grep -i "succeeded"
      register: operator_status
      until: operator_status.rc == 0
      changed_when: false
      retries: 30
      delay: 30
