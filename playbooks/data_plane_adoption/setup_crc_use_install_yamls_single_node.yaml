- hosts: all
  tasks:
    # this should be handled better by parent job, just for testing
    - name: Clone repos in the job workspace
      include_role:
        name: prepare-workspace

- hosts: controller
  vars:
    framework_dir: "/home/zuul/src/github.com/openstack-k8s-operators/ci-framework"

    rdo_dir: "/home/zuul/src/review.rdoproject.org/rdo-jobs/playbooks/data_plane_adoption"
  tasks:
    - name: Ensure ansible is installed
      become: true
      ansible.builtin.package:
        name:
          - ansible-core

    - name: Wait for crc to be ready by ci-framework
      ansible.builtin.include_tasks:
        file: "{{ framework_dir }}/ci/playbooks/wait-for-crc.yaml"

    - name: Initialize OC Credentials
      ansible.builtin.include_role:
        name: rhol_crc
        tasks_from: add_crc_creds.yml

    - name: Prepare ci-framework environment
      ansible.builtin.shell:
        cmd: |
          ansible-galaxy collection install community.general
          ansible-playbook ci_framework/playbooks/01-bootstrap.yml --tags bootstrap --skip-tags packages
        chdir: "{{ framework_dir }}"

    - name: Run install_yamls via ci-framework
      ansible.builtin.shell: |
          ansible-playbook {{ rdo_dir }}/ci_framework_install_yamls.yaml
      args:
        chdir: "{{ framework_dir }}"
