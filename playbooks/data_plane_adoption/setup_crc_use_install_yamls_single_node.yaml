- hosts: controller
  vars:
    framework_dir: "/home/zuul/src/github.com/openstack-k8s-operators/ci-framework"
    cifmw_parameters_file: "/home/zuul/vars.yaml"
    rdo_dir: "/home/zuul/src/review.rdoproject.org/rdo-jobs/playbooks/data_plane_adoption"
  tasks:
    - name: Prepare ci-framework environment and install openshift client
      ansible.builtin.shell:
        cmd: |
          ansible-galaxy collection install community.general
          ansible-playbook ci_framework/playbooks/01-bootstrap.yml --tags bootstrap
        chdir: "{{ framework_dir }}"

    - name: Dump parameters to a file to pass them easily to infra playbook
      ansible.builtin.copy:
        dest: "{{cifmw_parameters_file}}"
        content: |
          ---
          cifmw_basedir: "/home/zuul/ci-framework-data"
          cifmw_artifacts_crc_sshkey: "{{cifmw_artifacts_crc_sshkey}}"
          cifmw_openshift_user: "{{cifmw_openshift_user}}"
          cifmw_openshift_password: "{{cifmw_openshift_password}}"
          cifmw_openshift_api: "{{cifmw_openshift_api}}"
          cifmw_openshift_kubeconfig: "{{cifmw_openshift_kubeconfig}}"
          cifmw_openshift_skip_tls_verify: "{{cifmw_openshift_skip_tls_verify}}"
          cifmw_openshift_setup_skip_internal_registry_tls_verify: "{{cifmw_openshift_setup_skip_internal_registry_tls_verify}}"
          cifmw_use_libvirt: "{{cifmw_use_libvirt}}"
          cifmw_use_crc: "{{cifmw_use_crc}}"
 
    - name: Prepare openshift and libvirt environment
      ansible.builtin.shell:
        cmd: |
          ansible-playbook -v ci_framework/playbooks/02-infra.yml -e "@{{cifmw_parameters_file}}"
        chdir: "{{ framework_dir }}"

    - name: Run install_yamls via ci-framework
      environment:
        KUBECONFIG: "{{cifmw_openshift_kubeconfig}}"
      ansible.builtin.shell: |
          ansible-playbook -v {{ rdo_dir }}/ci_framework_install_yamls.yaml
      args:
        chdir: "{{ framework_dir }}"
