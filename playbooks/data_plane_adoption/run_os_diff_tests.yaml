- hosts: controller
  vars:
    od_dir: "/home/zuul-worker/src/github.com/openstack-k8s-operators/os-diff"
  tasks:
    - name: workaround zuul
      ignore_errors: true
      become: yes
      shell: |
        dnf -y install golang
        git clone https://github.com/openstack-k8s-operators/os-diff {{ od_dir }}

    - name: install os-diff
      shell: |
        cd {{ od_dir }}
        make install
      register: make_res
      become: yes

    - name: build os-diff
      shell: |
        cd {{ od_dir }}
        make build
      register: make_res
      become: yes

    - name: grab the crc VM IP address
      ansible.builtin.command: crc ip
      register: crc_ip

    - name: Set etc hosts entry for keystone glance placement cinder to crc VM IP
      become: true
      ansible.builtin.lineinfile:
        path: "/etc/hosts"
        insertafter: "EOF"
        value: "{{ crc_ip.stdout }} keystone-public-openstack.apps-crc.testing glance-public-openstack.apps-crc.testing placement-public-openstack.apps-crc.testing cinder-public-openstack.apps-crc.testing"

    - name: Install roles (should be done via make install)
      become: yes
      shell: |
        sed -i 's/crc/localhost/' {{ od_dir }}/hosts
        cp -R {{ od_dir }}/roles/* /usr/share/ansible/roles/

    - name: Workaround force posix install
      ignore_errors: yes
      become: yes
      shell: |
        mkdir -p /home/zuul-worker/.ansible/collections/ansible_collections/ansible
        mkdir -p /home/zuul/.ansible/collections/ansible_collections/ansible

    - name: Copy posix collection
      ignore_errors: yes
      become: yes
      shell: |
        cp -R /root/.ansible/collections/ansible_collections/ansible/posix /home/zuul-worker/.ansible/collections/ansible_collections/ansible/

    - name: Copy posix collection to /home/zuul
      ignore_errors: yes
      become: yes
      shell: |
        cp -R /home/zuul-worker/.ansible/collections/ansible_collections/ansible/posix /home/zuul/.ansible/collections/ansible_collections/ansible
        chown zuul:zuul -R /home/zuul/.ansible/collections

    - name: Source bashrc and confirm crc login
      ansible.builtin.shell: |
        source ~/.bashrc
        oc whoami

    # - name: Make sure all Openstack operators are deployed
    #   ignore_errors: true
    #   ansible.builtin.shell: |
    #     set -o pipefail && \
    #     oc get pods -n "openstack" --no-headers=true | grep -i "Running"
    #   register: operator_status
    #   until: operator_status.rc == 0
    #   changed_when: false
    #   retries: 30
    #   delay: 30
    # - name: Login CRC
    #   ignore_errors: yes
    #   ansible.builtin.include_role:
    #     name: collect_config
    #     tasks_from: ocp_login.yml

    - name: workaround
      become: yes
      shell: |
        cd {{ od_dir }}
        sed -i "/ansible_connection: local/a \  vars:\\n    oc_bin: oc" hosts
        sed -i "s/synchronize/ansible.posix.synchronize/" /home/zuul-worker/src/github.com/openstack-k8s-operators/os-diff/roles/collect_config/tasks/main.yml

    - name: Pull config from Crc os-diff
      shell: |
        cd {{ od_dir }}
        ./os-diff pull -c ocp

      # ansible.builtin.include_role:
      #   name: collect_config
      #   tasks_from: main.yml
      # vars:
      #   collect_ocp: true
      #   oc_login: false
      #   oc_bin: oc
      #   working_dir: "{{ ansible_user_dir }}"
      #   local_working_dir: "{{ ansible_user_dir }}"
      #   ansible_connection: local

    - name: Configure host for standalone
      become: yes
      shell: |
        cd {{ od_dir }}
        sed -i 's/\/home\/stack\/os-diff/\/home\/zuul-worker\/src\/github.com\/openstack-k8s-operators\/os-diff/' ansible.cfg

    - name: Slurp the standalone IP address
      ansible.builtin.slurp:
        path: /etc/nodepool/primary_node_private
      register: standalone_ip

    - name: cat standalone info in ssh.config
      become: true
      ignore_errors: yes
      shell: |
        cat  <<EOF >>/home/zuul-worker/src/github.com/openstack-k8s-operators/os-diff/ssh.config
        Host *
            IdentitiesOnly yes

        Host standalone
            Hostname {{ standalone_ip['content'] | b64decode | trim }}
            IdentityFile /home/zuul/.ssh/id_rsa
            User root
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
        EOF
        chown zuul:zuul /home/zuul-worker/src/github.com/openstack-k8s-operators/os-diff/ssh.config

    - name: Set etc hosts entry TripleO Standalone
      become: true
      ansible.builtin.lineinfile:
        path: "/etc/hosts"
        insertafter: "EOF"
        value: "standalone {{ standalone_ip['content'] | b64decode | trim }}"


    - name: Pull config from podman os-diff
      shell: |
        cd {{ od_dir }}
        #sed -i '$d' ansible.cfg
        ./os-diff pull -c podman --verbose

      # ansible.builtin.include_role:
      #   name: collect_config
      # vars:
      #   collect_podman: true
      #   working_dir: /home/zuul
      #   local_working_dir: /home/zuul

    - name: Compare config
      become: yes
      command:
        chdir: "{{ od_dir }}"
        cmd: ./os-diff compare -o /tmp/collect_tripleo_configs -d /tmp/collect_ocp_configs
