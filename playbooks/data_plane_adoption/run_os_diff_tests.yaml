- hosts: controller
  gather_facts: false
  vars:
    od_dir: "/home/zuul-worker/src/github.com/openstack-k8s-operators/os-diff"
  tasks:
    - name: workaround zuul
      ignore_errors: true
      become: yes
      shell: |
        dnf -y install golang
        git clone https://github.com/openstack-k8s-operators/os-diff {{ od_dir }}

    - name: install os-diff
      shell: |
        cd {{ od_dir }}
        make install
      register: make_res
      become: yes

    - name: build os-diff
      shell: |
        cd {{ od_dir }}
        make build
      register: make_res
      become: yes

    - name: grab the crc VM IP address
      ansible.builtin.command: crc ip
      register: crc_ip

    - name: Set etc hosts entry for keystone glance placement cinder to crc VM IP
      become: true
      ansible.builtin.lineinfile:
        path: "/etc/hosts"
        insertafter: "EOF"
        value: "{{ crc_ip.stdout }} keystone-public-openstack.apps-crc.testing glance-public-openstack.apps-crc.testing placement-public-openstack.apps-crc.testing cinder-public-openstack.apps-crc.testing"


    - name: Pull config from Crc os-diff
      become: yes
      shell: |
        cp -R {{ od_dir }}/roles/* /usr/share/ansible/roles/
        ansible-playbook -i {{ od_dir }}/hosts {{ od_dir }}/playbooks/collect_ocp_config.yaml -e '{"crc": false}'

    - name: Pull config from Standalone os-diff
      become: yes
      shell: |
        cd {{ od_dir }}
        sed -i 's/\/home\/stack\/os-diff/\/home\/zuul-worker\/src\/github.com\/openstack-k8s-operators\/os-diff/' ansible.cfg
        ansible-playbook -i {{ od_dir }}/hosts {{ od_dir }}/playbooks/collect_podman_config.yaml

      #./os-diff pull -c podman
      #command:
      #  chdir: "{{ od_dir }}"
      #  cmd: ./os-diff pull -c podman

    - name: Compare config
      become: yes
      command:
        chdir: "{{ od_dir }}"
        cmd: ./os-diff compare -o /tmp/collect_tripleo_configs -d /tmp/collect_ocp_configs
