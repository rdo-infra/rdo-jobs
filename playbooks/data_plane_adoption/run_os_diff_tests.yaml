- hosts: controller
  gather_facts: false
  vars:
    od_dir: "/home/zuul-worker/src/github.com/matbu/os-diff"
  tasks:
    - name: Get os-diff
      become: true
      shell: |
        mkdir -p /home/zuul-worker/src/github.com/matbu/
        git clone https://github.com/matbu/os-diff.git /home/zuul-worker/src/github.com/matbu/os-diff
        sed -i "s/\/home\/stack\/os-diff\/ssh\.config/\/home\/zuul-worker\/src\/github.com\/matbu\/os-diff\/ssh\.config/" /home/zuul-worker/src/github.com/matbu/os-diff/ansible.cfg

    - name: Install os-diff
      community.general.make:
        chdir: "{{ od_dir }}"
        target: install
      register: make_res
      #failed_when: '"failed=0" not in "{{ make_res.stdout_lines[-1:] }}"'
    
    #Debug job - tbr
    - name: debug
      debug: var=make_res

    - name: Build os-diff
      community.general.make:
        chdir: "{{ od_dir }}"
        target: build
      register: make_res
      failed_when: '"failed=0" not in "{{ make_res.stdout_lines[-1:] }}"'

    - name: Pull config from Crc os-diff
      command:
        chdir: "{{ od_dir }}"
        cmd: ./os-diff pull

    - name: Pull config from Standalone os-diff
      command:
        chdir: "{{ od_dir }}"
        cmd: ./os-diff pull -c podman

    - name: Compare config
      command:
        chdir: "{{ od_dir }}"
        cmd: ./os-diff compare -o /tmp/collect_tripleo_configs -d /tmp/collect_ocp_configs