- hosts: undercloud
  tasks:
    - name: Add hosts to access all tripleo nodes via controlplane
      vars:
        undercloud_ip: "{{ hostvars['undercloud']['ansible_host'] }}"
      ansible.builtin.add_host:
        name: "{{ item }}-through-undercloud"
        ansible_host: "192.168.122.{{ hostvars[item]['address_suffix'] }}"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no -J zuul@{{ undercloud_ip }}'
        ansible_user: zuul
        groups: tripleo_nodes
      loop: "{{ groups.all | select('match', '^overcloud*')  }}"

    - name: Show ip
      ansible.builtin.debug:
        msg: "{{ lookup('env', 'SSH_CLIENT') | split | first }}"

- hosts: localhost
  tasks:
    - name: Check access to overcloud node jumping through undercloud
      vars:
        undercloud_ip: "{{ hostvars['undercloud']['ansible_host'] }}"
      ansible.builtin.command: ssh -o StrictHostKeyChecking=no -J zuul@{{ undercloud_ip }} zuul@192.168.122.103 'touch /home/zuul/test.txt'
      register: ssh_output

    - name: Debug
      ansible.builtin.debug:
        msg: "{{ ssh_output }}"

    - name: Wait for 15 minutes to try to get on the node
      ansible.builtin.pause:
        minutes: 15

- hosts: tripleo_nodes
  become: true
  tasks:
    - name: Ensure iptables package is installed
      ansible.builtin.package:
        name: iptables

    - name: Add firewall rule to allow zuul executor to reach tripleo nodes
      vars:
        executor_ip: "{{ lookup('env', 'SSH_CLIENT') | split | first }}"
      ansible.builtin.iptables:
        action: "insert"
        chain: "INPUT"
        comment: "allow ssh access for zuul executor"
        in_interface: "eth0"
        jump: "ACCEPT"
        protocol: "tcp"
        source: "{{ executor_ip }}"
