---
- hosts: all
  tasks:
    - block:
        - name: Build repository from all builder rpms
          changed_when: true
          shell:
            cmd: |
                set -exuo pipefail
                mkdir -p build/buildset
                pushd build/buildset
                cp ~/rpmbuild/RPMS/*/*.rpm .
                createrepo .
                popd
            chdir: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/containers/libpod'].src_dir }}"
          args:
            warn: false

        - name: Copy repository
          become: true
          synchronize:
            src: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/containers/libpod'].src_dir }}/build/builset"
            dest: "{{ zuul.executor.log_root }}/buildset"
            mode: pull
            verify_host: true

      rescue:
        - name: Don't block
          debug:
            msg: copy of logs failed
