---
- hosts: all
  tasks:
    - name: Enable RHUI repository
      become: true
      when:
        - ansible_distribution_major_version >= "8"
        - ansible_distribution == "RedHat"
      shell: |
        set -euox pipefail
        dnf config-manager --enable rhui-*
        dnf makecache
        dnf repolist
      changed_when: true

    # epel needed to get mock
    - name: Enable EPEL repository for centos-8
      when:
        - ansible_distribution_major_version >= "8"
        - ansible_distribution == "CentOS"
      become: true
      block:

        - name: install epel-release
          package:
            name: epel-release

        # this is needed if epel-release was pre-installed as disabled
        - name: enable epel-release
          command: dnf config-manager --enable epel
          changed_when: true

    - name: Install pre-requisites
      become: true
      package:
        name:
          - createrepo
          - golang
          - mock
          - redhat-rpm-config
          - rpmdevtools
        state: present

    # Effective zuul user depends on the node, can be: zuul, zuul-worker
    - name: Add zuul user to mock group
      become: true
      user:
        name: "{{ ansible_user_id }}"
        groups: mock
      changed_when: true
