---
- hosts: all
  tasks:
    - name: Ensure mock environment
      include_role:
        name: ensure-mock

    - name: Setup to use bootstrap and disable warnings
      shell: |
          echo "config_opts['use_bootstrap_container'] = True" >> /etc/mock/site-defaults.cfg
          echo "config_opts['dnf_warning'] = False" >> /etc/mock/site-defaults.cfg
      become: true
      changed_when: true

    - name: Run make rpm
      shell:
        cmd: |
            export DIST="{{ dist | default('el7') }}"
            export MOCK_CONFIG="{{ mock_config | default('epel-7-x86_64') }}"
            make rpm
        chdir: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/ceph/ceph-ansible'].src_dir }}"
      changed_when: true

    - name: Setup log path fact
      include_role:
        name: set-zuul-log-path-fact

    - name: Define buildset artifacts location
      zuul_return:
        data:
          buildset_artifacts_url: "https://logs.rdoproject.org/{{ zuul_log_path }}/buildset"

    - name: Copy logs to logs directory
      changed_when: true
      shell:
        cmd: |
            mkdir logs
            cp *.log logs
            cp *.rpm logs
            pushd logs
            createrepo .
            popd
        chdir: "{{ ansible_user_dir }}/{{ zuul.projects['github.com/ceph/ceph-ansible'].src_dir }}"
      args:
        warn: false
