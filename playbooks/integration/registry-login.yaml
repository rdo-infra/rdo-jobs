- hosts: all
  vars:
    container_registry_logins:
        trunk.registry.rdoproject.org:
            unused: test
  tasks:
    - include_role:
        name: ansible-role-container-registry
        tasks_from: registry-login.yml
      vars:
        no_log_login: false

    # We can't use the real credentials in this test, so it's enough that we get
    # an "unauthorized" response from the registry, meaning that the interaction works.
    - name: Assert role has worked in centos 7
      when:
        - ansible_distribution == "CentOS"
        - ansible_distribution_major_version|int < 8
      assert:
        that:
          - registry_login_docker is defined
          - '"unauthorized" in registry_login.results.0.stdout'
        success_msg: Role got to the authentication phase and correctly failed
        fail_msg: Role failed authentication for an Unknown reason.

    - name: Assert role has worked in $distro 8
      when:
        (ansible_distribution == "CentOS" and ansible_distribution_major_version|int >= 8)
        or (ansible_distribution == "RedHat" and ansible_lsb.major_release|int >= 8)
      assert:
        that:
          - registry_login_podman is defined
          - '"unauthorized" in registry_login.results.0.stdout'
        success_msg: Role got to the authentication phase and correctly failed
        fail_msg: Role failed authentication for an Unknown reason.


