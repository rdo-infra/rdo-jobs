---
- hosts: primary
  tasks:
    - name: Run pre-quickstart role
      import_role:
         name: common

    - name: check for correct import
      debug:
        var: tripleo_root

    - name: set workspace
      set_fact:
        workspace: "{{ ansible_user_dir }}/workspace"

    - name: ensure workspace presence
      file:
        path: "{{ workspace }}"
        state: directory

    - name: Create release file
      shell:
        cmd: |
          # This builder, when run from a child job of validate-buildsys-tags
          # configures the temporary repositories created by it
          # This allows to install the packages in that repository and test
          # them.
          set +e -x
          # This job requires variable 'release' to be defined.

          if [ -z "{{ release|default("") }}" ]; then
              echo "ERROR in job definition"
              exit 1
          fi

          logs={{ buildset_artifacts_url|default("") }}

          # If we could not find a working repository, give up
          curl -o /dev/null -sIf "${logs}" || exit 1

          # Use the latest repository hash
          # If DLRN built multiple packages, there will be multiple repositories.
          # We want the latest repository which contains all of the packages that were just built.
          repository="${logs}/fedora/current"

          # The rdoinfo-DLRN-check job may create different repos (centos-rpm-master, centos-pike-rdo)
          # when it builds packages for more than one release. In that case, let us try to find the
          # right one
          curl -o /dev/null -sIf "${repository}"
          if [ $? -ne 0 ]; then
            releases="rpm-master stein-rdo rocky-rdo queens-rdo pike-rdo ocata-rdo"
            for release in $releases; do
                repository="${logs}/fedora-${release}/current"
                curl -o /dev/null -sIf "${repository}" || continue
                break
            done
          fi

          # If we could not find a working repository, give up
          curl -o /dev/null -sIf "${repository}" || exit 1
          PROMOTED_TAG="current-tripleo"
          dlrn_baseurl=`curl --silent https://trunk.rdoproject.org/fedora28-{{ release }}/$PROMOTED_TAG/delorean.repo -S  | grep baseurl | cut -d= -f2 | sed -e 's/\/*$//'`
          # FULL_HASH is needed as currently container build tags images based on it
          FULL_HASH=${dlrn_baseurl##*/}

          function create_config(){
              echo "artg_skipped_projects:"
              echo "  - rdoinfo"
              echo "release: {{ release }}"
              echo "docker_image_tag: $FULL_HASH"
              echo "dlrn_hash_tag: current-tripleo"
              echo "dlrn_target: fedora"
              echo "dlrn_baseurl: "https://trunk.rdoproject.org/fedora28-{{ release }}""
              echo "overcloud_image_url: http://images.rdoproject.org/{{ release }}/rdo_trunk/current-tripleo/overcloud-full.tar"
              echo "ipa_image_url: http://images.rdoproject.org/{{ release }}/rdo_trunk/current-tripleo/ironic-python-agent.tar"
              echo "images:"
              echo "  - name: overcloud-full"
              echo "    url: http://images.rdoproject.org/{{ release }}/rdo_trunk/current-tripleo/overcloud-full.tar"
              echo "    type: tar"
              echo "  - name: ipa_images"
              echo "    url: http://images.rdoproject.org/{{ release }}/rdo_trunk/current-tripleo/ironic-python-agent.tar"
              echo "    type: tar"
              echo "repo_cmd_before: |"
              echo "  sudo rpm -e epel-release || true;"
              echo "  sudo rm -rf /etc/yum.repos.d/delorean*;"
              echo "  sudo rm -rf /etc/yum.repos.d/*.rpmsave;"
              echo "  sudo dnf install -y dnf-plugins-core"
              echo "  sudo dnf clean all"
              echo "  sudo dnf config-manager --set-disabled '*'"
              echo "repos:"
              INDEX=0
              for repo in $REPOS_URL
              do
                  echo "  - type: file"
                  echo "    filename: delorean-$INDEX.repo"
                  echo "    down_url: $repo"
                  ((INDEX++))
              done
              echo "  - type: generic"
              echo "    reponame: temp-distgit"
              echo "    filename: temp-distgit.repo"
              echo "    baseurl: $repository"
              echo "    priority: 1"
              if [ ! -z $delorean_current_url ]; then
                  echo "  - type: generic"
                  echo "    reponame: delorean-current"
                  echo "    filename: delorean-current.repo"
                  echo "    baseurl: ${delorean_current_url}"
                  echo "    priority: 1"
                  echo "    includepkgs:"
                  echo "      - ansible-role-container-registry"
                  echo "      - ansible-role-tripleo*"
                  echo "      - ansible-tripleo-ipsec"
                  echo "      - instack"
                  echo "      - instack-undercloud"
                  echo "      - openstack-tripleo-*"
                  echo "      - os-apply-config"
                  echo "      - os-collect-config"
                  echo "      - os-net-config"
                  echo "      - os-refresh-config"
                  echo "      - puppet-*"
                  echo "      - python*-tripleo*"
                  echo "      - python*-paunch*"
                  echo "      - tripleo-ansible"
                  echo "      - ansible-config_template"
              fi
              echo "repo_cmd_after: |"
              echo "  sudo dnf install -y yum-plugin-priorities cronie;"
              echo "  sudo dnf repolist;"
              echo "  sudo dnf clean metadata;"
              echo "  sudo dnf update -y"
              echo "undercloud_rpm_dependencies: >-"
              echo "  python3-tripleoclient"
              echo "  cronie"
              echo "  rsyslog"
              echo "ansible_python_interpreter: /usr/bin/python3"
              echo "update_containers: true"
              echo "standalone_container_ceph_updates: true"
              echo "gating_repo_name: temp-*,gating-repo,delorean-current"
              echo "standalone_container_prep_update_repo: temp-*,delorean-current"
              echo "docker_registry_host: {{ push_registry | default('127.0.0.1:8787') }}"
              echo "standalone_container_prep_updates: true"
          }


              REPOS_URL="http://trunk.rdoproject.org/fedora28-{{ release }}/current-tripleo/delorean.repo http://trunk.rdoproject.org/fedora28-{{ release }}/delorean-deps.repo"
              delorean_current_url=`curl --silent https://trunk.rdoproject.org/fedora28-{{ release }}/current/delorean.repo -S  | grep baseurl | cut -d= -f2`
              create_config | tee -a tripleo.yml
        chdir: '{{ ansible_user_dir }}/workspace'
      environment: '{{ zuul | zuul_legacy_vars }}'

    - name: Build containers using build-containers role
      when:
        - rdoinfo_build_containers|default(false)
      block:
        - name: Apply repos using tripleo-repos role
          include_role:
            name: tripleo-repos
          vars:
            override_repos: "{{ buildcontainers_override_repos | default('') }}"
            tripleo_repos_repository: "{{ ansible_user_dir }}/{{ zuul.projects['opendev.org/openstack/tripleo-repos'].src_dir }}"
        - name: Install deps using bindep role
          include_role:
            name: bindep
          vars:
            bindep_dir: "{{ ansible_user_dir }}/{{ zuul.projects['opendev.org/openstack/python-tripleoclient'].src_dir }}"
        - name: Update priority for delorean repo
          become: true
          replace:
            regexp: "priority=1"
            replace: "priority=2"
            path: /etc/yum.repos.d/delorean.repo
        - name: Set repo facts
          set_fact:
            delorean_repos: "http://172.17.0.1/delorean.repo,http://172.17.0.1/delorean-{{ release }}-testing.repo"
          when: release == "master"
        - name: set url
          set_fact:
            extra_repo_url: "http://172.17.0.1/temp-distgit.repo"
            zuul_buildset_url: "{{ buildset_artifacts_url | default('') }}/fedora/current"
          when: buildset_artifacts_url is defined
          # To use packages included in the gating repo in build-containers role
        - name: install temp-distgit repo
          become: true
          template:
            src: "temp-distgit.repo.j2"
            dest: "/etc/yum.repos.d/temp-distgit.repo"
        - name: Run build containers pre tasks
          include_role:
            name: build-containers
            tasks_from: pre
        - name: install temp-buildys repo to httpd path
          become: true
          template:
            src: "temp-distgit.repo.j2"
            dest: "/var/www/html/temp-distgit.repo"
        - name: Build Containers
          include_role:
            name: build-containers
          vars:
            buildcontainers_rpm_setup_config: "{{ delorean_repos }},{{ extra_repo_url | default('') }}"

    - name: inject release file into quickstart
      shell:
        cmd: |
            TQ_SRC={{ ansible_user_dir  }}/{{ zuul['projects']['opendev.org/openstack/tripleo-quickstart']['src_dir']  }}
            sudo mv tripleo.yml ${TQ_SRC}/config/release/tripleo-ci/Fedora-28/{{ release }}.yml
            sudo setenforce 0
        chdir: '{{ ansible_user_dir }}/workspace'

    - name: Run quickstart
      include_role:
         name: run-test
      vars:
        release: "{{ release }}"

