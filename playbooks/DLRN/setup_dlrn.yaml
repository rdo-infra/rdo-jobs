---
- name: Setup build deps repo for mock
  yum_repository:
    name: delorean-ussuri-build-deps
    description: dlrn-ussuri-build-deps
    file: delorean-ussuri-build-deps
    baseurl: https://trunk.rdoproject.org/centos8-ussuri/build-deps/latest/
    gpgcheck: no
    enabled: yes
  become: true
  when:
    - ansible_distribution == "CentOS"
    - ansible_distribution_major_version == '8'

- name: Ensure bindep.txt dependencies are installed
  include_role:
    name: bindep
  vars:
    bindep_dir: "{{ ansible_user_dir }}/{{ zuul.projects['softwarefactory-project.io/DLRN'].src_dir }}"

- name: Run tools/test-setup.sh if exists
  include_role:
    name: test-setup
  vars:
    zuul_work_dir: "{{ ansible_user_dir }}/{{ zuul.projects['softwarefactory-project.io/DLRN'].src_dir }}"

- name: Remove build-deps repo
  yum_repository:
    name: delorean-ussuri-build-deps
    state: absent
  become: true
  when:
    - ansible_distribution == "CentOS"
    - ansible_distribution_major_version == '8'

- name: Ensure user in mock group
  user:
    name: "{{ ansible_user }}"
    groups: mock
    append: true
  become: true
