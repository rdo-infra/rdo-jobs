- hosts: all
  roles:
    - role: prepare-workspace
  tasks:
    - name: Check if worker can sudo
      command: sudo -n true
      failed_when: false
      changed_when: false
      register: _worker_is_sudoer

    - name: Temporary install centos-packager from copr
      shell:
        cmd: |
          YUM="{{ ansible_pkg_mgr }}"
          sudo $YUM install -y epel-release;
          sudo $YUM config-manager --enable epel;
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/ykarel/ykarel-centos-stream/centos-stream-x86_64/01239149-python-centos/python-centos-0.1.1-2.el8.noarch.rpm;
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/ykarel/ykarel-centos-stream/centos-stream-x86_64/01239164-centos-packager/centos-packager-0.5.5-2.el8.noarch.rpm;
          sudo $YUM config-manager --disable epel;
      changed_when: true
      when: ansible_distribution_major_version|int > 7

    - import_role:
        name: configure-mirrors
      vars:
        mirror_fqdn: "mirror.{{ nodepool.region | lower }}.{{ nodepool.cloud | lower }}.rdoproject.org"
      when:
        - _worker_is_sudoer.rc == 0
        - ansible_distribution != "Fedora" or (ansible_distribution == "Fedora" and ansible_distribution_major_version|int > 28)
