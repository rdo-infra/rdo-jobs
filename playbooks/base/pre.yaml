- hosts: all
  tasks:
    - block:
        - include_role: name=prepare-workspace
      when: "ansible_connection != 'kubectl'"

    - import_role: name=ensure-output-dirs
      when: ansible_user_dir is defined

    - name: Check if worker can sudo
      command: sudo -n true
      failed_when: false
      changed_when: false
      register: _worker_is_sudoer

    - import_role:
        name: add-authorized-keys
      vars:
        public_keys:
          - public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDD8aivX74oe3JCjNA9LHSBXfnZzbuzibJmK57xWQGMRanKgjPeBZja3OQ+p+1LF2YINflpR2/ZvtiTxCcdzBIQvebTBOcZFawgIsg5ML4Jv/Sdpu7U473oJAjkGcWncXn8+1JOUmCHQWcLD3CZ1yrLD1AG4j4qknpZz31lAsmyJVDE/kE4JAPJVzrumSfm5oBebhkLlr6kFXguIC+5NMtmP4RLC1+naf6LxTVLnFH6BENQnyerM5a/6t+KyPuHc5MQ3HtVZ4d7SYOa0tf5ybfC6edlGW9FA+vkekF9phZ2ub59gKWnD1evKzR6CFnW1igNzK0Fu7zKrmXrBDYmGDJ/ ykarel@yatinkarel
"

    - import_role:
        name: configure-mirrors
      vars:
        mirror_fqdn: "mirror.{{ nodepool.region | lower }}.{{ nodepool.cloud | lower }}.rdoproject.org"
      when:
        - ansible_connection != 'kubectl'
        - _worker_is_sudoer.rc == 0
        - ansible_distribution != "Fedora" or (ansible_distribution == "Fedora" and ansible_distribution_major_version|int > 28)
