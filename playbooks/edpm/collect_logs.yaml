- hosts: controller
  gather_facts: false
  tasks:
    - name: Collect pod logs
      ansible.builtin.shell: |
        source ~/.bashrc
        mkdir -p logs/controller/pod
        chmod -R a+r "{{ ansible_user_dir }}/openstack"
        chown -R {{ ansible_user }}: "{{ ansible_user_dir }}/openstack"
        pushd logs/controller
        ip a > network.txt
        ip ro ls >> network.txt
        oc get pods > all_pods.txt
        all_pods=$(oc get pods -o name)
        for pod in $all_pods; do
          echo $pod
          oc logs $pod > ${pod}-logs.txt
          oc get -o yaml $pod > ${pod}.yaml
          oc describe $pod > ${pod}-describe.txt
        done
        test -d /etc/nodepool && rsync -r /etc/nodepool ./
        popd
        rsync -r /home/zuul-worker/src/github.com/openstack-k8s-operators/install_yamls/out ./install_yamls_out
      args:
        chdir: "{{ ansible_user_dir }}/openstack"
      changed_when: true

- hosts: secondary
  gather_facts: false
  tasks:
    - name: Collect logs from edpm node
      ansible.builtin.shell: |
        mkdir -p openstack/logs/secondary
        chmod -R a+r "{{ ansible_user_dir }}/openstack"
        chown -R {{ ansible_user }}: "{{ ansible_user_dir }}/openstack"
        pushd openstack/logs
        ip a > secondary/network.txt
        ip ro ls >> secondary/network.txt
        rpm -qa > secondary/rpm_qa.txt
        sudo podman images > secondary/podman_images.txt
        sudo cp -r /etc/nftables /var/lib/edpm-config secondary/
        sudo journalctl -p warning -t kernel -o short -g DROPPING --no-pager &> secondary/firewall-drops.txt
        sudo journalctl -o short --no-pager -u sshd > secondary/sshd.log
        sudo chown -R {{ansible_user}}: secondary
        test -d /etc/nodepool && rsync -r /etc/nodepool ./secondary/
        popd
      args:
        chdir: "{{ ansible_user_dir }}"
      changed_when: true

- hosts: all
  gather_facts: false
  tasks:
    - name: Copy files from {{ ansible_user_dir }}/openstack on node
      # ansible.posix.synchronize does not work with zuul-executor
      synchronize:
        src: '{{ ansible_user_dir }}/openstack/'
        dest: '{{ zuul.executor.log_root }}'
        mode: pull
        copy_links: true
        verify_host: true
        rsync_opts:
          - --include=/etc/**
          - --include=/conf/**
          - --include=/logs/**
          - --include=*/
          - --prune-empty-dirs
