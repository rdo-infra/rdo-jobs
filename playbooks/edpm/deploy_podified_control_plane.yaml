- hosts: controller
  tasks:
    - name: Print the current CRC version
      ansible.builtin.shell: |
        crc version

    - name: Initialize OC Credentials
      ansible.builtin.include_role:
        name: add_crc_creds

    - name: Build and push openstack-runner image
      ansible.builtin.shell: |
        pushd {{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/edpm-ansible
        git log -1
        TAG=$(git show-ref --head --hash head)
        popd
        EEIMG=quay.rdoproject.org/openstack-k8s-operators/openstack-ansibleee-runner:${TAG}
        make docker-build-ee EEIMG=${EEIMG} EDPM_LOCAL_REPO={{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/edpm-ansible
        make docker-push-ee EEIMG=${EEIMG}
      args:
        chdir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/openstack-ansibleee-operator"
      register: ee_runner_out

    - name: Show Build and Push openstack-runner image output
      ansible.builtin.debug: var=ee_runner_out.stdout_lines

    - name: Build and push openstack-ansibleee-operator bundle image
      ansible.builtin.shell: |
        podman pull docker.io/library/golang:1.19
        git log -1
        TAG=$(git show-ref --head --hash head)
        IMAGE_TAG_BASE=quay.rdoproject.org/openstack-k8s-operators/openstack-ansibleee-operator
        make docker-build docker-push IMG=IMG=${IMAGE_TAG_BASE}:${TAG}
        make bundle IMG=${IMAGE_TAG_BASE}:${TAG}
        make bundle-build BUNDLE_IMG=${IMAGE_TAG_BASE}-bundle:${TAG}
        podman push ${IMAGE_TAG_BASE}-bundle:${TAG}
        make catalog-build CATALOG_IMG=${IMAGE_TAG_BASE}-index:${TAG}
        make catalog-push CATALOG_IMG=${IMAGE_TAG_BASE}-index:${TAG}
      args:
        chdir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/openstack-ansibleee-operator"
      register: runner_out

    - name: Show Build and Push openstack-runner image output
      ansible.builtin.debug: var=runner_out.stdout_lines

    - name: Set the openstack-runner image tag
      ansible.builtin.shell: |
        git show-ref --head --hash head
      args:
        chdir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/edpm-ansible"
      register: ee_image_out

    - name: Get subnode IP
      register: subnode_ip
      ansible.builtin.slurp:
        path: "/etc/nodepool/sub_nodes_private"

    - name: Get Controller IP
      ansible.builtin.slurp:
        path: /etc/nodepool/node_private
      register: controller_ip

    - name: Extract SSH_CONNECTION content
      ansible.builtin.set_fact:
        zuul_worker_ip: >-
          {% set ssh_env = lookup('env', 'SSH_CONNECTION') | split %}
          {{ ssh_env[0::2] }}

    - name: Set some EDPM requested variables
      ansible.builtin.set_fact:
        ee_image: "quay.rdoproject.org/openstack-k8s-operators/openstack-ansibleee-runner:{{ ee_image_out.stdout }}"
        ee_subnode_ip: "{{ subnode_ip['content'] | b64decode | trim }}"
        edpm_sshd_allowed_ranges: ["0.0.0.0/0", "{{ zuul_worker_ip }}", "{{ controller_ip['content'] | b64decode | trim }}"]
        cacheable: true

    - name: Set the openstack-ansibleee-operator image tag
      ansible.builtin.shell: |
        git show-ref --head --hash head
      args:
        chdir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/openstack-ansibleee-operator"
      register: ee_operator_out

    - name: Set the openstack-ansibleee-operator image
      ansible.builtin.set_fact:
        ansibleee_img: "quay.rdoproject.org/openstack-k8s-operators/openstack-ansibleee-operator-index:{{ ee_operator_out.stdout }}"
        ansibleee_repo: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/openstack-ansibleee-operator"
        cacheable: true

    - name: Deploy podified control plane using install_yamls
      vars:
        storage_class: standard
        namespace: openstack
        run_crc_storage: true
        run_openstack_deploy: true
        create_openstack_cr: true
        run_script: true
        run_ansibleee: true
      ansible.builtin.include_role:
        name: use_install_yamls

    - name: Add additional sleep in order to finish the deploy
      ansible.builtin.shell: |
        sleep 200
      args:
        executable: /bin/bash

    - name: Debug some values
      debug:
        msg: |
          EDPM_COMPUTE_IP: "{{ ee_subnode_ip }}"
          OPENSTACK_RUNNER_IMG: "{{ ee_image }}"
          EDPM_NETWORK_CONFIG_TEMPLATE: "templates/ci/multinode.j2"
          SSH_KEY_FILE: "{{ ansible_user_dir }}/.ssh/id_rsa"
          EDPM_SSHD_ALLOWED_RANGES: "{{ edpm_sshd_allowed_ranges }}"

    - name: Run EDPM Play
      ansible.builtin.command:
        cmd: make edpm_play
        chdir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/install_yamls/devsetup"
      environment:
        EDPM_COMPUTE_IP: "{{ ee_subnode_ip }}"
        OPENSTACK_RUNNER_IMG: "{{ ee_image }}"
        EDPM_NETWORK_CONFIG_TEMPLATE: "templates/ci/multinode.j2"
        SSH_KEY_FILE: "{{ ansible_user_dir }}/.ssh/id_rsa"
        EDPM_SSHD_ALLOWED_RANGES: "{{ edpm_sshd_allowed_ranges }}"

    - name: Get deploy-external-dataplane-compute pod name
      register: deploy_external_pod_name
      ansible.builtin.shell:
        cmd: oc get pods -o name | grep -m1 deploy-external
        executable: /bin/bash
      until: deploy_external_pod_name.rc == 0
      retries: 5
      delay: 5

    # oc wait is experimental. setting timeout to 0 will make it immediate.
    # We'll retry 100 times, with a 20 seconds delay between retries.
    # The "Completed" state we can see in the "oc get pods" is actually "Succeeded"
    # in the json output.
    - name: Wait for deploy-external-dataplane-compute to finish
      register: deploy_external_status
      ansible.builtin.shell:
        cmd: "oc wait --timeout=0 --for=jsonpath='{.status.phase}'=Succeeded {{ deploy_external_pod_name.stdout |trim }}"
      until: deploy_external_status.rc == 0
      retries: 100
      delay: 20

    - name: Get the logs of EDPM Play
      ansible.builtin.shell:
        cmd: "oc logs -f {{ deploy_external_pod_name.stdout |trim }}"
        executable: /bin/bash
