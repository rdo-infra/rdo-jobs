---
- hosts: all
  vars:
  tasks:
    - name: Install rdopkg
      shell:
        cmd: |
          set -e
          # Need to inherit system-site-packages for python-yum
          virtualenv --system-site-packages {{ ansible_user_dir }}/.venv
          source {{ ansible_user_dir }}/.venv/bin/activate
          pushd {{ ansible_user_dir }}/{{ zuul.projects['softwarefactory-project.io/rdopkg'].src_dir }}/
          pip install .
          popd
      changed_when: false
      args:
        chdir: "{{ ansible_user_dir }}"

    - name: Fetch rdopkg compatible name for project {{ zuul.project.name }}
      shell:
        cmd: |
          set -e
          source {{ ansible_user_dir }}/.venv/bin/activate
          rdopkg findpkg {{ zuul.project.name }} | sed -n "/^name/ s/name. \(.*\)/\1/p"
      changed_when: false
      register: findpkg
      args:
        chdir: "{{ ansible_user_dir }}"

    - name: Clone and reqcheck project with rdopkg
      shell:
        cmd: |
          set -e
          source {{ ansible_user_dir }}/.venv/bin/activate
          rdopkg clone {{ findpkg.stdout }}
          pushd {{ ansible_user_dir }}/{{ findpkg.stdout }}
          cp {{ ansible_user_dir }}/{{ zuul.project.src_dir }}/* .
          rdopkg reqcheck --strict
          popd
      changed_when: false
      args:
        chdir: "{{ ansible_user_dir }}"
