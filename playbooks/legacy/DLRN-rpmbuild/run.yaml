- hosts: all
  tasks:
    - name: Ensure bindep.txt dependencies are installed
      include_role:
        name: bindep
        bindep_dir: "{{ ansible_user_dir }}/{{ zuul.projects['managesf.softwarefactory-project.io/DLRN'].src_dir }}"

    - name: Run tools/test-setup.sh if exists
      include_role:
        name: test-setup
        zuul_work_dir: "{{ ansible_user_dir }}/{{ zuul.projects['managesf.softwarefactory-project.io/DLRN'].src_dir }}"

    - name: Add zuul user to mock group
      shell:
        cmd: |
          sudo usermod -a -G mock zuul

    - name: Ensure mirrors are setup properly
      shell:
        cmd: |
            source /etc/ci/mirror_info.sh
            sed -e "s|^#baseurl=http://mirror.centos.org/centos|baseurl=$NODEPOOL_CENTOS_MIRROR|;/^mirrorlist=/d" -i scripts/centos.cfg
        chdir: "{{ ansible_user_dir }}/{{ zuul.projects['managesf.softwarefactory-project.io/DLRN'].src_dir }}"

    - shell:
        cmd: |
          if [[ "$ZUUL_PIPELINE" =~ "openstack-" ]]; then
              timeout --signal=SIGKILL 3600 ./scripts/run_project_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git
              ret=$?
          else
              timeout --signal=SIGKILL 3600 ./scripts/run_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git "centos" "https://trunk.rdoproject.org/centos7/" ""
              ret=$?
          fi
        chdir: "{{ ansible_user_dir }}/{{ zuul.projects['managesf.softwarefactory-project.io/DLRN'].src_dir }}"
