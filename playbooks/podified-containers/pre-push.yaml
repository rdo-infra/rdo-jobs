---
- hosts: primary
  tasks:
    - name: Clone repos in the job workspace
      ansible.builtin.include_role:
        name: prepare-workspace

    - name: Create .ansible/plugins dir
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.ansible/plugins"
        state: directory

    - name: Expose ci-framework custom plugins
      ansible.builtin.copy:
        src: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/ci-framework/ci_framework/plugins/"
        dest: "{{ ansible_user_dir }}/.ansible/plugins"
        remote_src: true

    - name: Install copy_containers
      ansible.builtin.include_role:
        name: copy_container
        tasks_from: main
      vars:
        enable_cron: false
        enable_cron_c9: false

    - name: Create the config file
      ansible.builtin.template:
        src: "{{ playbook_dir }}/files/copy-quay-config.yaml.j2"
        dest: "{{ work_dir }}/copy-quay-config.yaml"
        mode: '0755'
