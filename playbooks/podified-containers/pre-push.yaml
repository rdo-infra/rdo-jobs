---
- hosts: primary
  tasks:
    - name: Install required packages
      become: true
      ansible.builtin.package:
        name:
          - device-mapper-devel
          - gpgme-devel
          - btrfs-progs-devel
          - golang

    - name: Create temporary directory
      ansible.builtin.tempfile:
        state: directory
        suffix: copy-container
      register: temporary_copy_container_dir

    - name: Copy go files to temporary directory
      ansible.builtin.copy:
        src: copy-quay/
        dest: "{{ temporary_copy_container_dir.path }}"

    - name: Build the copy-container
      ansible.builtin.command:
        cmd: go build
        chdir: "{{ temporary_copy_container_dir.path }}"
      register: go_build
      changed_when: false

    - name: Copy binary to /usr/local/bin
      become: true
      ansible.builtin.copy:
        src: "{{ temporary_copy_container_dir.path }}/copy-quay"
        dest: /usr/local/bin
        mode: '0755'
        remote_src: true
      when: go_build.rc == 0 and ansible_distribution == 'CentOS'

    - name: Delete temporary directory
      ansible.builtin.file:
        path: "{{ temporary_copy_container_dir.path }}"
        state: absent

    - name: Create the config file
      ansible.builtin.template:
        src: {{ playbook_dir }}/files/copy-quay-config.yaml.j2
        dest:  {{ work_dir }}/copy-quay-config.yaml
        mode: '0755'

    # TODO: Use go to get DLRN hash from job file
    - name: Get md5 file for DLRN hash tag
      ansible.builtin.get_url:
        url: "{{ trunk_url }}/{{ ansible_distribution|lower }}{{ ansible_distribution_major_version }}-{{ openstack_release}}/{{ promote_source }}/delorean.repo.md5"
        dest: "{{ ansible_user_dir }}/delorean.repo.md5"

    - name: Find MD5 value
      ansible.builtin.command: "cat {{ ansible_user_dir }}/delorean.repo.md5"
      register: DLRN_hash
