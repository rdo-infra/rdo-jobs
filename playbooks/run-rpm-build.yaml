---
- hosts: primary
  tasks:
    - name: Run pre-quickstart role
      import_role:
         name: common

    - name: check for correct import
      debug:
        var: tripleo_root

    - name: set workspace
      set_fact:
        workspace: "{{ ansible_user_dir }}/workspace"

    - name: ensure workspace presence
      file:
        path: "{{ workspace }}"
        state: directory

    - name: Add built repo
      become: yes
      copy:
        dest: "/etc/yum.repos.d/zuul-build.repo"
        content: |
          {% for artifact in zuul.artifacts|default([]) %}{% if artifact.name == 'repo' %}
          [{{ artifact.project | regex_replace('/', '_') }}-{{ artifact.change }}-{{ artifact.patchset }}]
          name={{ artifact.project }}-{{ artifact.change }}-{{ artifact.patchset }}
          enabled=1
          baseurl={{ artifact.url }}
          gpgcheck=0

          {% endif %}{% endfor %}

    - name: Run quickstart
      include_role:
         name: run-test
      vars:
        release: "{{ release }}"
