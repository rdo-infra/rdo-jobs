- hosts: fake_registry
  vars:
    registry_username: test
    registry_password: test
  tasks:
    - name: configure credentials on registry
      copy:
        content: |
            test
        dest: /etc/docker/registry/config.yml

- hosts: all:!fake_registry
  tasks:
    - set_fact:
        role_failed: false

    - name: ensure role fails when credentials missing
      block:
        - include_role:
            name: registry_login
      rescue:
        - debug:
            msg: Expected failure for role while credentials are missing
        - set_fact:
            role_failed: true

    - fail:
      when: role_failed == false

- hosts: centos7
  vars:
    docker_login_cache: /root/.docker/config.json
    docker_socket: /var/run/docker.sock
    registry_username: test
    registry_password: test
    registry_host: fake_registry
  tasks:
    - include_role:
        name: registry_login
      vars:
        cleanup: false

    - block:
        - name: verify docker login credentials were created
          stat:
            path: "{{ docker_login_cache }}"
          register: cache_file
          failed_when: not cache_file.stat.exists
      rescue:
        - debug:
            msg: Unable to find docker credential cache

    - block:
        # TODO: do an operation with docker and podman to ensure the credentials can be used
        - name: Ensure docker can use credentials
          debug:
            msg: "Not implemented"
      rescue:
        - debug:
            msg: "Error while using docker credentials"

    - include_role:
        name: registry_login
        tasks_from: cleanup.yaml

    - block:
        - name: ensure docker is still running after the login
          stat:
            path: "{{ docker_socket }}"
      rescue:
        - debug:
            msg: Unable to find docker socket file


- hosts: redhat8
  vars:
    podman_login_cache: /var/run/user/0/containers/auth.json
    registry_username: test
    registry_password: test
    registry_host: fake_registry
  tasks:
    - include_role:
        name: registry_login
      vars:
        cleanup: false

    - block:
        - name: verify docker login credentials were created
          stat:
            path: "{{ docker_login_cache }}"
          register: cache_file
          failed_when: not cache_file.stat.exists
      rescue:
        - debug:
            msg: Unable to find docker credential cache

    - block:
        - name: verify podman login credentials were created
          stat:
            path: "{{ podman_login_cache }}"
          register: cache_file
          failed_when: not cache_file.stat.exists
      rescue:
        - debug:
            msg: Unable to find podman credential cache

    - block:
        # TODO: do an operation with docker and podman to ensure the credentials can be used
        - name: Ensure podman can use credentials
          debug:
            msg: "Not implemented"
      rescue:
        - debug:
            msg: "Error while using podman credentials"

    - include_role:
        name: registry_login
        tasks_from: cleanup.yaml

