---
- name: Foce the model_per_project option for known job to have different output per project
  set_fact:
    logclassify_model_per_project: true
  when: "'tox' in zuul.job"

- name: Set model name
  set_fact:
    _model_name: "{% if logclassify_model_per_project %}{{ zuul.project.name }}/{% endif %}{{ zuul.job }}/{{ zuul.branch }}.clf"

- name: Set model path
  set_fact:
    _model_path: "{{ logclassify_model_dir }}/{{ _model_name }}"

- name: Set report name
  set_fact:
    _report_name: "{% if logclassify_report %}report{% else %}log-classify{% endif %}"

- name: Create directories
  file:
    path: "{{ item }}"
    owner: "{{ ansible_user }}"
    mode: 0700
    state: directory
  loop:
    - "{{ _model_path|dirname }}"
    - "{{ logclassify_tmp_dir }}"

- name: Download pre-built model
  get_url:
    url: "{{ logclassify_model_store_url }}/{{ _model_name }}"
    dest: "{{ _model_path }}"
  failed_when: false

- name: Check pre-built model
  command: "{{ logclassify_cmd }} model-check {{ _model_path }} --max-age {{ logclassify_model_age }}"
  register: _model_check
  failed_when: _model_check.rc not in [0, 4]

- name: Detect anomalies
  command: >
    timeout {{ logclassify_max_run_time }}s {{ logclassify_cmd }} dir-run {{ _model_path }}
      --threshold {{ logclassify_threshold }}
      --before-context {{ logclassify_before_context }}
      --after-context {{ logclassify_after_context }}
      {% if logclassify_logserver_dir %}
          {{ logclassify_local_dir }}
      {% else %}
          {{ logclassify_local_dir }}/job-output.txt
      {% endif %}
      --html {{ logclassify_tmp_dir }}/{{ _report_name }}.html
      {% if logclassify_static_location %}--static-location {{ logclassify_static_location }}{% endif %}
      {% if logclassify_logserver_dir %}--include-path {{ logclassify_logserver_dir }}{% endif %}
      {% for _path in logclassify_exclude_paths %}--exclude-path {{ _path }}{% endfor %}
      {% for _path in logclassify_exclude_files %}--exclude-file {{ _path }}{% endfor %}
  register: _model_run
  failed_when: _model_run.rc not in [0, 4]
  when:
    - _model_check.rc == 0

- name: Fetch report
  synchronize:
    src: "{{ logclassify_tmp_dir }}/{{ _report_name }}.{{ item }}"
    dest: "{{ zuul.executor.log_root }}/{{ _report_name }}.{{ item }}"
    mode: pull
  loop:
    - html
    - json
  when:
    - _model_check.rc == 0
    - _model_run.rc == 0
