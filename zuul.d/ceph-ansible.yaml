---
- job:
    # This is an abstract job to share common bits for each ooo-ceph integration jobs
    name: tripleo-ceph-integration
    # abstract means you can't use it directly, it can only be the parent of a job.
    abstract: true
    pre-run: playbooks/tripleo-ceph-integration/pre.yaml
    run: playbooks/tripleo-ceph-integration/run.yaml
    post-run: playbooks/tripleo-ceph-integration/post.yaml
    # files makes the job run only if one of the elem is modified by the PR
    # files:
    #   Until job is working as expected, use a test file trigger
    #   - test-ci
    #   When the job is working, only run it when those files are modified
    #   - roles/.*
    #   - plugins/.*
    #   - library/.*
    #   - group_vars/.*
    nodeset:
      nodes:
        - name: test
          label: rdo-centos-7

- job:
    name: tripleo-ceph-integration-master
    parent: tripleo-ceph-integration
    required-projects:
      # without options, the branch of the PR is used for the required-projects
      - name: opendev.org/openstack/tripleo-heat-templates
      - name: github.com/ceph/ceph-ansible
    vars:
      dist: "el8"
      mock_config: "epel-8-x86_64"


- job:
    name: tripleo-ceph-integration-rocky
    parent: tripleo-ceph-integration
    # this job run only for stable-3.2 PR
    branches: stable-3.2
    required-projects:
      - name: opendev.org/openstack/tripleo-heat-templates
        # using override-checkout, we can map ceph-ansible branch to rdo branch
        override-checkout: stable/rocky
      - name: github.com/ceph/ceph-ansible

- job:
    name: tripleo-ceph-integration-queens
    parent: tripleo-ceph-integration
    # this job run only for stable-3.2 PR
    branches: stable-3.2
    required-projects:
      - name: opendev.org/openstack/tripleo-heat-templates
        # using override-checkout, we can map ceph-ansible branch to rdo branch
        override-checkout: stable/queens
      - name: github.com/ceph/ceph-ansible

- job:
    name: tripleo-ceph-integration-train
    parent: tripleo-ceph-integration
    branches: stable-4.0
    required-projects:
      - name: opendev.org/openstack/tripleo-heat-templates
        override-checkout: stable/train
      - name: github.com/ceph/ceph-ansible
    vars:
      dist: "el8"
      mock_config: "epel-8-x86_64"


# RHEL 8 Jobs
# TODO(arxcruz): remove this job after this patch get merged
- job:
    name: tripleo-ceph-integration-rhel-8-standalone-featureset016
    parent: tripleo-ci-rhel-8-standalone-rdo
    run: playbooks/run-rpm-build.yaml
    required-projects:
      # without options, the branch of the PR is used for the required-projects
      - name: opendev.org/openstack/tripleo-heat-templates
      - name: github.com/ceph/ceph-ansible
    vars:
      featureset: '052'
      release: master
      standalone_ceph: true
      featureset_override:
        standalone_environment_files:
          - 'environments/low-memory-usage.yaml'
          - 'ci/environments/scenario001-standalone.yaml'
        tempest_services:
          - aodh
        run_tempest: false
        use_os_tempest: true
        tempest_run_concurrency: 1
        tempest_tempest_conf_overrides:
          telemetry.alarm_granularity: '60'
          auth.tempest_roles: "Member"
        tempest_test_whitelist:
          - 'tempest.api.identity.v3'
          - 'tempest.scenario.test_volume_boot_pattern.TestVolumeBootPattern.test_volume_boot_pattern'
          - 'telemetry_tempest_plugin.scenario.test_telemetry_integration.TestTelemetryIntegration'

- job:
    name: tripleo-ceph-integration-rhel-8-scenario001-standalone
    parent: tripleo-ci-rhel-8-standalone-rdo
    run: playbooks/run-rpm-build.yaml
    required-projects:
      # without options, the branch of the PR is used for the required-projects
      - name: opendev.org/openstack/tripleo-heat-templates
      - name: github.com/ceph/ceph-ansible
    vars:
      featureset: '052'
      release: master
      standalone_ceph: true
      featureset_override:
        standalone_environment_files:
          - 'environments/low-memory-usage.yaml'
          - 'ci/environments/scenario001-standalone.yaml'
        tempest_services:
          - aodh
        run_tempest: false
        use_os_tempest: false
        tempest_run_concurrency: 1
        tempest_tempest_conf_overrides:
          telemetry.alarm_granularity: '60'
          auth.tempest_roles: "Member"
        tempest_test_whitelist:
          - 'tempest.api.identity.v3'
          - 'tempest.scenario.test_volume_boot_pattern.TestVolumeBootPattern.test_volume_boot_pattern'
          - 'telemetry_tempest_plugin.scenario.test_telemetry_integration.TestTelemetryIntegration'

- job:
    name: tripleo-ceph-integration-rhel-8-scenario004-standalone
    parent: tripleo-ci-rhel-8-standalone-rdo
    run: playbooks/run-rpm-build.yaml
    required-projects:
      # without options, the branch of the PR is used for the required-projects
      - name: opendev.org/openstack/tripleo-heat-templates
      - name: github.com/ceph/ceph-ansible
    vars:
      featureset_override: &scenario004_podman
        run_tempest: false
        standalone_environment_files:
          - 'environments/low-memory-usage.yaml'
          - 'ci/environments/scenario004-standalone.yaml'
          - 'environments/podman.yaml'
        tempest_services:
          - manila
        tempest_tempest_conf_overrides:
          'auth.tempest_roles': 'Member'
          'share.multitenancy_enabled': 'False'
          'share.enable_protocols': 'cephfs'
          'share.capability_snapshot_support': 'False'
          'share.capability_create_share_from_snapshot_support': 'False'
        tempest_test_whitelist:
          - 'tempest.scenario.test_network_basic_ops.TestNetworkBasicOps.test_network_basic_ops'
          - 'manila_tempest_tests.tests.api.test_shares.SharesCephFSTest.test_create_get_delete_share'
        use_os_tempest: false

- job:
    name: tripleo-ceph-integration-rhel-8-scenario001-standalone-train
    parent: tripleo-ci-rhel-8-standalone-rdo
    run: playbooks/run-rpm-build.yaml
    branches: ^stable-4.0$
    required-projects:
      # without options, the branch of the PR is used for the required-projects
      - name: opendev.org/openstack/tripleo-heat-templates
        override-checkout: stable/train
      - name: github.com/ceph/ceph-ansible
    vars:
      featureset: '052'
      release: train
      standalone_ceph: true
      featureset_override:
        standalone_environment_files:
          - 'environments/low-memory-usage.yaml'
          - 'ci/environments/scenario001-standalone.yaml'
        run_tempest: false
        use_os_tempest: false

- job:
    name: tripleo-ceph-integration-rhel-8-scenario004-standalone-train
    parent: tripleo-ci-rhel-8-standalone-rdo
    run: playbooks/run-rpm-build.yaml
    required-projects:
      # without options, the branch of the PR is used for the required-projects
      - name: opendev.org/openstack/tripleo-heat-templates
        override-checkout: stable/train
      - name: github.com/ceph/ceph-ansible
    branches: ^stable-4.0$
    vars:
      featureset: '052'
      release: train
      standalone_ceph: true
      featureset_override:
        run_tempest: false
        standalone_environment_files:
          - 'environments/low-memory-usage.yaml'
          - 'ci/environments/scenario004-standalone.yaml'
          - 'environments/podman.yaml'
        use_os_tempest: false
