- job:
    name: base
    parent: base-minimal
    # min version to use (needed mainly to make rhel8 python detection work)
    ansible-version: 2.8
    # if your jobs rely on code that does need an older version of ansible
    # you can still override this in them.
    description:
      The base job for RDO's installation of Zuul.

      All jobs ultimately inherit from this. But we parent to
      base-minimal for things like secrets. Care should taken on
      modifying this job, since everything uses it.

      Changes to this job will be self testing.
    abstract: true
    pre-run: playbooks/base/pre.yaml
    vars:
      ara_report_type: database
      ara_report_path: ara-report

- job:
    name: legacy-base
    abstract: true
    description: |
      Base job for autoconverted legacy jobs
    pre-run: playbooks/legacy/pre.yaml
    nodeset: rdo-centos-7

# NOTE(pabelanger): We should be consuming openstack-zuul-jobs here, but we have
# to pull in more nodesets.  We can first test using this.
- job:
    name: legacy-dsvm-base
    abstract: true
    description: |
      Base job for autoconverted legacy devstack-gate jobs

      This job runs devstack-gate with as few changes as possible and
      may be used by jobs which have been automatically converted as
      part of the migration to Zuul v3.
    pre-run: playbooks/legacy/pre.yaml
    nodeset: legacy-upstream-centos-7
    required-projects:
      - opendev.org/openstack/devstack
      - opendev.org/openstack/devstack-gate
      - opendev.org/openstack/tripleo-ci
      - opendev.org/openstack/ceilometer
      - opendev.org/openstack/ceilometermiddleware
      - opendev.org/openstack/cinder
      - opendev.org/openstack/django_openstack_auth
      - opendev.org/openstack/glance
      - opendev.org/openstack/glance_store
      - opendev.org/openstack/heat
      - opendev.org/openstack/heat-cfntools
      - opendev.org/openstack/heat-templates
      - opendev.org/openstack/horizon
      - opendev.org/openstack/keystone
      - opendev.org/openstack/keystoneauth
      - opendev.org/openstack/keystonemiddleware
      - opendev.org/openstack/manila
      - opendev.org/openstack/manila-ui
      - opendev.org/openstack/neutron
      - opendev.org/openstack/neutron-fwaas
      - opendev.org/openstack/neutron-lbaas
      - opendev.org/openstack/neutron-vpnaas
      - opendev.org/openstack/nova
      - opendev.org/openstack/placement
      - opendev.org/openstack/octavia
      - opendev.org/openstack/os-apply-config
      - opendev.org/openstack/os-brick
      - opendev.org/openstack/os-client-config
      - opendev.org/openstack/os-collect-config
      - opendev.org/openstack/os-net-config
      - opendev.org/openstack/os-refresh-config
      - opendev.org/openstack/osc-lib
      - opendev.org/openstack/requirements
      - opendev.org/openstack/swift
      - opendev.org/openstack/tempest
      - opendev.org/openstack/tripleo-heat-templates
      - opendev.org/openstack/tripleo-common
      - opendev.org/openstack/tripleo-image-elements
      - opendev.org/openstack/zaqar

# NOTE(pabelanger): We should be consuming openstack-zuul-jobs here, but we have
# to pull in more nodesets.  We can first test using this.
- job:
    name: legacy-dsvm-base-multinode
    abstract: true
    parent: legacy-dsvm-base
    description: |
      Base job for multinode devstack jobs.

      Will setup firewall rules on all the nodes allowing them to talk to
      each other.
    pre-run:
      - playbooks/legacy/multinode-networking/pre.yaml
      - playbooks/legacy/tripleo-ci/ceph.yaml
    roles:
      - zuul: zuul/zuul-jobs
    nodeset: upstream-centos-7-2-node

# NOTE(pabelanger): We parent to legacy-tripleo-ci-periodic-base here because we
# need dlrnapi secret, this is exactly the same as above.
- job:
    name: legacy-tripleo-ci-periodic-multinode
    parent: legacy-tripleo-ci-periodic-base
    description: |
      Base job for multinode devstack jobs.

      Will setup firewall rules on all the nodes allowing them to talk to
      each other.
    pre-run:
      - playbooks/legacy/multinode-networking/pre.yaml
      - playbooks/legacy/tripleo-ci/ceph.yaml
    roles:
      - zuul: zuul/zuul-jobs
    nodeset: upstream-centos-7-2-node

- job:
    name: legacy-tripleo-ci-periodic-multinode-upload
    parent: legacy-tripleo-ci-periodic-base-upload
    description: |
      Base job for multinode devstack jobs.

      Will setup firewall rules on all the nodes allowing them to talk to
      each other.
    pre-run: playbooks/legacy/multinode-networking/pre.yaml
    roles:
      - zuul: zuul/zuul-jobs
    nodeset: upstream-centos-7-2-node

- job:
    name: octavia-build-amphora
    parent: publish-rdoproject-artifacts
    run: playbooks/octavia-build-amphora/run.yaml
    post-run: playbooks/octavia-build-amphora/post.yaml

- job:
    name: rdo-tox-molecule
    parent: tripleo-tox-molecule
    nodeset: rdo-centos-8
    # default tox based job timeout of 1800 is far too low for functional testing on some
    # repositories.
    timeout: 3600
    pre-run:
      - playbooks/rdo-tox-molecule-pre.yaml
    vars:
      tox_environment:
        # assure we skip delegated scenarios as we are supposed to test them
        # with separated jobs.
        PYTEST_ADDOPTS: -m "not delegated"

- job:
    name: rdo-tox-molecule-delegated-centos-8
    parent: rdo-tox-molecule
    nodeset: rdo-centos-8
    vars:
      tox_envlist: molecule_delegated
      tox_environment:
        PYTEST_ADDOPTS: -m "delegated"

- job:
    name: rdopkg-reqcheck
    description: |
      Dependency check with "rdopkg reqcheck"
    parent: base
    run: playbooks/reqcheck/run.yaml
    nodeset: container-fedora
    required-projects:
      - rdopkg

- job:
    name: rdo-tox-molecule-rhel8
    parent: tripleo-tox-molecule
    voting: false
    nodeset: rdo-fedora-stable
    vars:
      tox_environment:
        MOLECULE_PLATFORM: rhel8
        MOLECULE_IMAGE: ubi8/python-36
        MOLECULE_CONTAINER_REGISTRY_URL: registry.access.redhat.com

- job:
    name: DLRN-build-tripleo-base
    parent: base
    run: playbooks/DLRN-build-tripleo/run.yaml
    post-run: playbooks/DLRN-build-tripleo/post.yaml
    voting: false
    nodeset: rdo-centos-7
    required-projects:
      - DLRN

- job:
    name: DLRN-build-tripleo
    parent: DLRN-build-tripleo-base
    branches: ^(queens-rdo)|(rocky-rdo)|(stein-rdo)|(train-rdo)$
    dependencies:
      - DLRN-rpmbuild

- job:
    name: DLRN-build-tripleo-centos8
    parent: DLRN-build-tripleo-base
    branches: ^(rpm-master)$
    dependencies:
      - DLRN-rpmbuild-centos8
    vars:
      centos_version: 'centos8'
    nodeset: rdo-centos-8

- job:
    name: DLRN-rpmbuild-base
    run: playbooks/DLRN/rpmbuild.yaml
    post-run: playbooks/DLRN/post.yaml
    nodeset: rdo-centos-7
    required-projects:
      - DLRN
      - rdoinfo

- job:
    name: DLRN-rpmbuild
    parent: DLRN-rpmbuild-base
    branches: ^(queens-rdo)|(rocky-rdo)|(stein-rdo)|(train-rdo)$

- job:
    name: DLRN-rpmbuild-nv
    parent: DLRN-rpmbuild-base
    voting: false
    branches: ^rpm-master$

- job:
    name: DLRN-rpmbuild-pinned
    parent: DLRN-rpmbuild
    voting: false
    vars:
      tag: 'ussuri-uc'

- job:
    name: DLRN-rpmbuild-rpm-packaging-centos
    timeout: 5400
    run: playbooks/DLRN/rpmbuild-rpm-packaging-centos.yaml
    post-run: playbooks/DLRN/post.yaml
    nodeset: rdo-centos-7-vexxhost
    required-projects:
      - openstack/rpm-packaging
      - DLRN

- job:
    name: DLRN-rpmbuild-rpm-packaging-centos-8
    timeout: 10800
    run: playbooks/DLRN/rpmbuild-rpm-packaging-centos-8.yaml
    post-run: playbooks/DLRN/post.yaml
    nodeset: rdo-centos-8-vexxhost
    required-projects:
      - openstack/rpm-packaging
      - DLRN

- job:
    name: DLRN-rpmbuild-centos8
    parent: DLRN-rpmbuild-base
    branches: ^(rpm-master)|(train-rdo)$
    vars:
      centos_version: 'centos8'
    nodeset: rdo-centos-8

- job:
    name: DLRN-rpmbuild-centos8-pinned
    parent: DLRN-rpmbuild-centos8
    vars:
      tag: 'ussuri-uc'
      centos_version: 'centos8'

- job:
    name: rpmlint
    run: playbooks/rpmlint/run.yaml
    dependencies:
      - DLRN-rpmbuild
    branches: ^rpm-master$
    nodeset: rdo-centos-8

- job:
    name: rdoinfo-DLRN-check
    run: playbooks/rdoinfo/DLRN-check.yaml
    post-run: playbooks/rdoinfo/DLRN-check-post.yaml
    timeout: 10800
    nodeset: rdo-centos-7
    required-projects:
      - DLRN
      - rdoinfo

- job:
    name: rdoinfo-DLRN-check-nv
    parent: rdoinfo-DLRN-check
    voting: false

- job:
    name: rdoinfo-DLRN-check-centos8
    parent: rdoinfo-DLRN-check
    timeout: 18000
    vars:
      centos_version: centos8
    nodeset: rdo-centos-8
